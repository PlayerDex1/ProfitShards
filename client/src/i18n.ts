import React, { createContext, useContext, useEffect, useMemo, useState } from 'react';

type Lang = 'pt' | 'en';

type Dict = Record<string, string>;

const dicts: Record<Lang, Dict> = {
  pt: {
    'header.title': 'ProfitShards',
    'header.subtitle': 'WorldShards Tools: Builds, Drops, Results',
    'header.login': 'Entrar',
    'header.logout': 'Sair',
    'header.theme': 'Alternar tema',
    'header.lang': 'Idioma',

    'auth.title': 'Entrar',
    'auth.username': 'Apelido',
    'auth.password': 'Senha',
    'auth.cancel': 'Cancelar',
    'auth.login': 'Entrar',
    'auth.note': 'As credenciais ficam apenas no seu navegador.',

    'equipment.title': 'Equipamento - ',
    'equipment.config': 'Configura√ß√£o de equipamento para esta sess√£o',
    'equipment.rarity': 'Raridade',
    'equipment.luck': 'Sorte',
    'equipment.totalLuck': 'Total de Sorte',
    'equipment.save': 'Salvar',
    'equipment.cancel': 'Cancelar',
    'equipment.apply': 'Aplicar',
    'equipment.applyBuildB': 'Aplicar Build B',
    'equipment.builds': 'Builds Salvas',
    'equipment.builds.none': 'Nenhuma build salva ainda',
    'equipment.builds.name': 'Nome da build',
    'equipment.export': 'Exportar (copiar)',
    'equipment.import': 'Importar',
    'equipment.exportFile': 'Baixar JSON',
    'equipment.importFile': 'Carregar JSON',
    'equipment.share': 'Compartilhar link',
    'equipment.compare': 'Comparar Builds',
    'equipment.selectA': 'Selecione Build A',
    'equipment.selectB': 'Selecione Build B',
    'equipment.luckA': 'Sorte A',
    'equipment.luckB': 'Sorte B',
    'equipment.diff': 'Diferen√ßa',
    'equipment.effect': 'Efeito estimado',
    'equipment.tip.title': 'Dica',
    'equipment.tip.body': 'Use os presets de raridade e os bot√µes ¬± para ajustes r√°pidos. Suas builds e sess√µes s√£o salvas por usu√°rio.',
    'equipment.whatif': 'What‚Äëif de Sorte',
    'equipment.whatif.hint': 'Ajuste para simular total de Sorte e ver impacto nos c√°lculos.',
    'equipment.compareNote': 'A diferen√ßa e o efeito s√£o estimativas baseadas apenas na Sorte total.',
    'equipment.import.prompt': 'Cole o JSON das builds:',
    'equipment.button': 'Equipamento (Sorte: {luck})',
    'equipment.slot.weapon': 'Arma',
    'equipment.slot.axe': 'Machado',
    'equipment.slot.armor': 'Armadura',
    'equipment.slot.pickaxe': 'Picareta',
    'equipment.rarity.comum': 'Comum',
    'equipment.rarity.incomum': 'Incomum',
    'equipment.rarity.raro': 'Raro',
    'equipment.rarity.√©pico': '√âpico',
    'equipment.rarity.lend√°rio': 'Lend√°rio',
    'equipment.rarity.m√≠tico': 'M√≠tico',

    'results.totalTokenValue': 'Valor Total dos Tokens',
    'results.gemsCost': 'Custo das Gemas',
    'results.grossProfit': 'Lucro Bruto',
    'results.rebuyCost': 'Custo Recompra Gemas',
    'results.roi': 'ROI',
    'results.no_history': 'Nenhum c√°lculo salvo ainda',
    'results.history_will_appear': 'Seus c√°lculos aparecer√£o aqui automaticamente',
    'results.finalProfitTitle': 'Lucro L√≠quido Final',
    'results.finalProfit': 'FinalProfit',
    'results.profitable': 'Investimento Lucrativo',
    'results.loss': 'Preju√≠zo',
    'results.summaryTitle': 'Resumo',
    'results.tokenDistribution': 'Distribui√ß√£o de Tokens',
    'results.equipTokens': 'Token gasto na acelera√ß√£o',
    'results.farmedTokens': 'Tokens Farmados',
    'results.totalTokensCount': 'Total de Tokens',
    'results.efficiencyMetrics': 'M√©tricas de Efici√™ncia',
    'results.totalTokensLabel': 'Total de Tokens',
    'results.netTokens': 'Tokens L√≠quidos',
    'results.farmEfficiency': 'Efici√™ncia Farm',
    'results.performanceOverTime': 'Performance ao Longo do Tempo',
    'results.history.title': 'Hist√≥rico de C√°lculos',
    'results.history.show': 'Mostrar',
    'results.history.hide': 'Ocultar',
    'results.history.clear': 'Limpar',
    'results.history.clickToShow': 'Clique em "Mostrar" para ver o hist√≥rico',
    'results.tokenLabel': 'Tokens',
    'results.profitLabel': 'Lucro',

    '404.title': '404 P√°gina n√£o encontrada',
    '404.hint': 'Voc√™ esqueceu de adicionar a p√°gina ao roteador?',

    'calc.title': 'Calculadora',
    'calc.investment': 'Investimento Inicial (USD)',
    'calc.gemsConsumed': 'Gemas Consumidas',
    'calc.loadsUsed': 'Cargas Utilizadas',
    'calc.gemsPurchased': 'Gemas Compradas',
    'calc.tokensEquipment': 'Token gasto na acelera√ß√£o',
    'calc.tokenPrice': 'Pre√ßo Token (USD)',
    'calc.gemsRemaining': 'Gemas Restantes',
    'calc.tokensFarmed': 'Tokens Farmados',
    'calc.gemPrice': 'Pre√ßo Gema (USD)',
    'calc.button': 'Salvar no Hist√≥rico',

    'sidebar.summary': 'Resumo R√°pido',
    'sidebar.totalProfit': 'Lucro Total',
    'sidebar.roi': 'ROI',
    'sidebar.efficiency': 'Efici√™ncia',
    'sidebar.nav.calculator': 'Calculadora',
    'sidebar.nav.equipment': 'Equipamentos',
    'sidebar.nav.history': 'Hist√≥rico',

    'home.calculator': 'Calculadora',

    // Navigation
    'nav.backToMain': 'Voltar ao Menu Principal',
    'nav.openProfile': 'Abrir Perfil (Sorte: {luck})',
    'nav.openProfileUser': 'Abrir Perfil ({user})',

    'auth.guest': 'Convidado',

    'donate.title': 'Doa√ß√£o',
    'donate.openloot': 'Creator OL',
    'donate.wallet': 'Carteira EVM',
    'donate.copy': 'Copiar',
    'donate.copied': 'Copiado!',
    'support.title': 'Apoie o Projeto',
    'support.ambassador': 'OpenLoot (Embaixador)',
    'support.ambassador.cta': 'Ambassador OpenLoot',
    'support.donate': 'Doe para manter o site online',
    'planner.title': 'Planejador de Mapa',
    'planner.mapSize': 'Tamanho do mapa',
    'planner.small': 'Pequeno',
    'planner.medium': 'M√©dio',
    'planner.large': 'Grande',
    'planner.xlarge': 'Extra grande',
    'planner.energyCost': 'Energia por mapa',
    'planner.loads': 'Cargas (n¬∫ de runs)',
    'planner.tokensDropped': 'Tokens dropados',
    'planner.luck': 'Sorte (Luck)',
    'planner.status': 'Status',
    'planner.apply': 'Salvar no mini hist√≥rico',
    'planner.example': 'ex.: 30 no mapa m√©dio',
    'planner.history': 'Mini hist√≥rico (2 dias)',
    'planner.noHistory': 'Nenhum registro de drop nos √∫ltimos 2 dias',
    'planner.when': 'Quando',
    'metrics.title': 'M√©tricas (√∫ltimos 2 dias)',
    'metrics.title24h': 'M√©tricas (√∫ltimas 24h)',
    'metrics.avgPerRun': 'M√©dia de tokens por carga',
    'metrics.totalByDay': 'Total por dia',
    'metrics.bestHour': 'Melhor hor√°rio',
    'metrics.noData': 'Sem dados suficientes',
    'metrics.runShort': 'carga',
    'planner.clear': 'Limpar hist√≥rico',
    'planner.delete': 'Excluir',

    // Status labels
    'status.excellent': 'Excelente',
    'status.positive': 'Positivo',
    'status.negative': 'Negativo',
    'status.neutral': 'Neutro',

    // Profile page
    'profile.title': 'Perfil',
    'profile.welcome': 'Ol√°, {name}! üëã',
    'profile.subtitle': 'Configura√ß√µes e hist√≥rico sincronizados automaticamente',
    'profile.subtitleLocal': 'Dados salvos localmente no navegador',
    'profile.of': 'Perfil de {name}',

    // Equipment settings
    'equipment.userSettings': 'Configura√ß√µes do Usu√°rio',
    'equipment.nickname': 'Nickname',
    'equipment.nicknameEdit': 'Editar',
    'equipment.nicknameSave': 'Salvar',
    'equipment.nicknameCancel': 'Cancelar',
    'equipment.nicknamePlaceholder': 'Digite seu nickname',
    'equipment.nicknameDescription': 'Seu nickname ser√° exibido publicamente nos rankings e estat√≠sticas',
    'equipment.nicknameLoading': 'Carregando...',

    // Analytics Dashboard
    'analytics.title': 'Analytics Avan√ßados',
    'analytics.globalData': 'Dados Globais',
    'analytics.adminTools': 'Ferramentas Admin',
    'analytics.update': 'Atualizar',
    'analytics.loading': 'Carregando analytics...',
    'analytics.loadingGlobal': 'Carregando dados globais...',
    'analytics.hourlyActivity': 'Atividade por Hor√°rio',
    'analytics.mapEfficiency': 'Efici√™ncia por Mapa',
    'analytics.topUsers': 'Top Usu√°rios',
    'analytics.totalRuns': 'Total Runs',
    'analytics.totalTokens': 'Total Tokens',
    'analytics.activeUsers': 'Usu√°rios Ativos',
    'analytics.globalAverage': 'M√©dia Global',
    'analytics.luckRange': 'Faixa de Luck',
    'analytics.runs': 'Runs',
    'analytics.tokens': 'Tokens',
    'analytics.average': 'M√©dia',
    'analytics.users': 'Usu√°rios',

    // Admin Tools
    'admin.title': 'Ferramentas Administrativas',
    'admin.exportData': 'Exportar Dados',
    'admin.exportDescription': 'Baixar todos os dados do sistema',
    'admin.exportCSV': 'CSV',
    'admin.exportJSON': 'JSON',
    'admin.backupDatabase': 'Backup Database',
    'admin.backupDescription': 'Criar backup completo do D1',
    'admin.createBackup': 'Criar Backup',
    'admin.cleanData': 'Limpeza de Dados',
    'admin.cleanDescription': 'Remover dados antigos (90+ dias)',
    'admin.cleanOld': 'Limpar Antigos',
    'admin.testD1': 'Teste D1',
    'admin.testD1Description': 'Testar conectividade do banco',
    'admin.testDatabase': 'Testar D1',
    'admin.processing': 'Processando...',

    // Common
    'common.error': 'Erro',
    'common.success': 'Sucesso',
    'common.loading': 'Carregando',
    'common.save': 'Salvar',
    'common.cancel': 'Cancelar',
    'common.edit': 'Editar',
    'common.delete': 'Excluir',
    'common.copy': 'Copiar',
  },
  en: {
    'header.title': 'ProfitShards',
    'header.subtitle': 'WorldShards Tools: Builds, Drops, Results',
    'header.login': 'Sign in',
    'header.logout': 'Sign out',
    'header.theme': 'Toggle theme',
    'header.lang': 'Language',

    'auth.title': 'Sign in',
    'auth.username': 'Nickname',
    'auth.password': 'Password',
    'auth.cancel': 'Cancel',
    'auth.login': 'Sign in',
    'auth.note': 'Credentials are stored only in your browser.',

    'equipment.title': 'Equipment - ',
    'equipment.config': 'Equipment configuration for this session',
    'equipment.rarity': 'Rarity',
    'equipment.luck': 'Luck',
    'equipment.totalLuck': 'Total Luck',
    'equipment.save': 'Save',
    'equipment.cancel': 'Cancel',
    'equipment.apply': 'Apply',
    'equipment.applyBuildB': 'Apply Build B',
    'equipment.builds': 'Saved Builds',
    'equipment.builds.none': 'No builds saved yet',
    'equipment.builds.name': 'Build name',
    'equipment.export': 'Export (copy)',
    'equipment.import': 'Import',
    'equipment.exportFile': 'Download JSON',
    'equipment.importFile': 'Upload JSON',
    'equipment.share': 'Share link',
    'equipment.compare': 'Compare Builds',
    'equipment.selectA': 'Select Build A',
    'equipment.selectB': 'Select Build B',
    'equipment.luckA': 'Luck A',
    'equipment.luckB': 'Luck B',
    'equipment.diff': 'Difference',
    'equipment.effect': 'Estimated effect',
    'equipment.tip.title': 'Tip',
    'equipment.tip.body': 'Use rarity presets and ¬± buttons for quick adjustments. Your builds and sessions are saved per user.',
    'equipment.whatif': 'Luck What‚Äëif',
    'equipment.whatif.hint': 'Adjust to simulate total Luck and see impact.',
    'equipment.compareNote': 'Difference and effect are estimates based only on total Luck.',
    'equipment.import.prompt': 'Paste builds JSON:',
    'equipment.button': 'Equipment (Luck: {luck})',
    'equipment.slot.weapon': 'Weapon',
    'equipment.slot.axe': 'Axe',
    'equipment.slot.armor': 'Armor',
    'equipment.slot.pickaxe': 'Pickaxe',
    'equipment.rarity.comum': 'Common',
    'equipment.rarity.incomum': 'Uncommon',
    'equipment.rarity.raro': 'Rare',
    'equipment.rarity.√©pico': 'Epic',
    'equipment.rarity.lend√°rio': 'Legendary',
    'equipment.rarity.m√≠tico': 'Mythic',

    'results.totalTokenValue': 'Total Token Value',
    'results.gemsCost': 'Gems Cost',
    'results.grossProfit': 'Gross Profit',
    'results.rebuyCost': 'Gems Rebuy Cost',
    'results.roi': 'ROI',
    'results.no_history': 'No calculations saved yet',
    'results.history_will_appear': 'Your calculations will appear here automatically',
    'results.finalProfitTitle': 'Final Net Profit',
    'results.finalProfit': 'FinalProfit',
    'results.profitable': 'Profitable Investment',
    'results.loss': 'Loss',
    'results.summaryTitle': 'Summary',
    'results.tokenDistribution': 'Token Distribution',
    'results.equipTokens': 'Acceleration token spent',
    'results.farmedTokens': 'Farmed Tokens',
    'results.totalTokensCount': 'Total Tokens',
    'results.efficiencyMetrics': 'Efficiency Metrics',
    'results.totalTokensLabel': 'Total Tokens',
    'results.netTokens': 'Net Tokens',
    'results.farmEfficiency': 'Farm Efficiency',
    'results.performanceOverTime': 'Performance Over Time',
    'results.history.title': 'Calculations History',
    'results.history.show': 'Show',
    'results.history.hide': 'Hide',
    'results.history.clear': 'Clear',
    'results.history.clickToShow': 'Click "Show" to view history',

    '404.title': '404 Page Not Found',
    '404.hint': 'Did you forget to add the page to the router?',

    'results.tokenLabel': 'Tokens',
    'results.profitLabel': 'Profit',

    'calc.title': 'Calculator',
    'calc.investment': 'Initial Investment (USD)',
    'calc.gemsConsumed': 'Gems Consumed',
    'calc.loadsUsed': 'Loads Used',
    'calc.gemsPurchased': 'Gems Purchased',
    'calc.tokensEquipment': 'Acceleration token spent',
    'calc.tokenPrice': 'Token Price (USD)',
    'calc.gemsRemaining': 'Gems Remaining',
    'calc.tokensFarmed': 'Farmed Tokens',
    'calc.gemPrice': 'Gem Price (USD)',
    'calc.button': 'Calculate Net Profit',

    'sidebar.summary': 'Quick Summary',
    'sidebar.totalProfit': 'Total Profit',
    'sidebar.roi': 'ROI',
    'sidebar.efficiency': 'Efficiency',
    'sidebar.nav.calculator': 'Calculator',
    'sidebar.nav.equipment': 'Equipment',
    'sidebar.nav.history': 'History',

    'home.calculator': 'Calculator',

    // Navigation
    'nav.backToMain': 'Back to Main Menu',
    'nav.openProfile': 'Open Profile (Luck: {luck})',
    'nav.openProfileUser': 'Open Profile ({user})',

    'auth.guest': 'Guest',

    'donate.title': 'Donation',
    'donate.openloot': 'Creator OL',
    'donate.wallet': 'EVM Wallet',
    'donate.copy': 'Copy',
    'donate.copied': 'Copied!',
    'support.title': 'Support the Project',
    'support.ambassador': 'OpenLoot (Ambassador)',
    'support.ambassador.cta': 'Ambassador OpenLoot',
    'support.donate': 'Donate to keep the site online',
    'planner.title': 'Map Planner',
    'planner.mapSize': 'Map size',
    'planner.small': 'Small',
    'planner.medium': 'Medium',
    'planner.large': 'Large',
    'planner.xlarge': 'Extra large',
    'planner.energyCost': 'Energy per map',
    'planner.loads': 'Loads (runs)',
    'planner.tokensDropped': 'Tokens dropped',
    'planner.luck': 'Luck',
    'planner.status': 'Status',
    'planner.apply': 'Save to mini history',
    'planner.example': 'e.g., 30 on medium map',
    'planner.history': 'Mini history (2 days)',
    'planner.noHistory': 'No drop records in last 2 days',
    'planner.when': 'When',
    'metrics.title': 'Metrics (last 2 days)',
    'metrics.title24h': 'Metrics (last 24h)',
    'metrics.avgPerRun': 'Avg tokens per load',
    'metrics.totalByDay': 'Total per day',
    'metrics.bestHour': 'Best hour',
    'metrics.noData': 'No data yet',
    'metrics.runShort': 'load',
    'planner.clear': 'Clear history',
    'planner.delete': 'Delete',

    // Status labels
    'status.excellent': 'Excellent',
    'status.positive': 'Positive',
    'status.negative': 'Negative',
    'status.neutral': 'Neutral',

    // Profile page
    'profile.title': 'Profile',
    'profile.welcome': 'Hello, {name}! üëã',
    'profile.subtitle': 'Settings and history automatically synchronized',
    'profile.subtitleLocal': 'Data saved locally in browser',
    'profile.of': '{name}\'s Profile',

    // Equipment settings
    'equipment.userSettings': 'User Settings',
    'equipment.nickname': 'Nickname',
    'equipment.nicknameEdit': 'Edit',
    'equipment.nicknameSave': 'Save',
    'equipment.nicknameCancel': 'Cancel',
    'equipment.nicknamePlaceholder': 'Enter your nickname',
    'equipment.nicknameDescription': 'Your nickname will be displayed publicly in rankings and statistics',
    'equipment.nicknameLoading': 'Loading...',

    // Analytics Dashboard
    'analytics.title': 'Advanced Analytics',
    'analytics.globalData': 'Global Data',
    'analytics.adminTools': 'Admin Tools',
    'analytics.update': 'Update',
    'analytics.loading': 'Loading analytics...',
    'analytics.loadingGlobal': 'Loading global data...',
    'analytics.hourlyActivity': 'Hourly Activity',
    'analytics.mapEfficiency': 'Map Efficiency',
    'analytics.topUsers': 'Top Users',
    'analytics.totalRuns': 'Total Runs',
    'analytics.totalTokens': 'Total Tokens',
    'analytics.activeUsers': 'Active Users',
    'analytics.globalAverage': 'Global Average',
    'analytics.luckRange': 'Luck Range',
    'analytics.runs': 'Runs',
    'analytics.tokens': 'Tokens',
    'analytics.average': 'Average',
    'analytics.users': 'Users',

    // Admin Tools
    'admin.title': 'Administrative Tools',
    'admin.exportData': 'Export Data',
    'admin.exportDescription': 'Download all system data',
    'admin.exportCSV': 'CSV',
    'admin.exportJSON': 'JSON',
    'admin.backupDatabase': 'Backup Database',
    'admin.backupDescription': 'Create complete D1 backup',
    'admin.createBackup': 'Create Backup',
    'admin.cleanData': 'Data Cleanup',
    'admin.cleanDescription': 'Remove old data (90+ days)',
    'admin.cleanOld': 'Clean Old Data',
    'admin.testD1': 'Test D1',
    'admin.testD1Description': 'Test database connectivity',
    'admin.testDatabase': 'Test D1',
    'admin.processing': 'Processing...',

    // Common
    'common.error': 'Error',
    'common.success': 'Success',
    'common.loading': 'Loading',
    'common.save': 'Save',
    'common.cancel': 'Cancel',
    'common.edit': 'Edit',
    'common.delete': 'Delete',
    'common.copy': 'Copy',
  },
};

const LangContext = createContext<{ lang: Lang; setLang: (l: Lang) => void; t: (k: string) => string }>({ lang: 'pt', setLang: () => {}, t: (k) => k });

export function I18nProvider({ children }: { children: React.ReactNode }) {
  const [lang, setLangState] = useState<Lang>('pt');

  useEffect(() => {
    const saved = localStorage.getItem('worldshards-lang') as Lang | null;
    if (saved === 'en' || saved === 'pt') setLangState(saved);
  }, []);

  const setLang = (l: Lang) => {
    setLangState(l);
    localStorage.setItem('worldshards-lang', l);
    window.dispatchEvent(new CustomEvent('worldshards-lang-updated'));
  };

  const t = useMemo(() => (key: string) => dicts[lang][key] ?? key, [lang]);

  return React.createElement(LangContext.Provider, { value: { lang, setLang, t } }, children);
}

export function useI18n() {
  return useContext(LangContext);
}